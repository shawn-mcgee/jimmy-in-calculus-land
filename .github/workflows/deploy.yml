name: Deploy to GitHub Pages

on:
  push:
    branches:
      - main
      - master

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Download Godot Engine
        run: |
          mkdir -p godot_engine
          cd godot_engine
          wget --tries=3 --timeout=10 https://github.com/godotengine/godot-builds/releases/download/4.5-stable/Godot_v4.5-stable_linux.x86_64.zip || \
          wget --tries=3 --timeout=10 https://downloads.tuxfamily.org/godotengine/4.5/Godot_v4.5-stable_linux.x86_64.zip
          unzip Godot_v4.5-stable_linux.x86_64.zip
          chmod +x Godot_v4.5-stable_linux.x86_64
          cd ..
      
      - name: Download and setup export templates
        run: |
          mkdir -p ~/.local/share/godot/export_templates
          cd ~/.local/share/godot/export_templates
          wget --tries=3 --timeout=10 https://github.com/godotengine/godot-builds/releases/download/4.5-stable/Godot_v4.5-stable_export_templates.tpz || \
          wget --tries=3 --timeout=10 https://downloads.tuxfamily.org/godotengine/4.5/Godot_v4.5-stable_export_templates.tpz
          unzip -q Godot_v4.5-stable_export_templates.tpz
          mv templates/* 4.5.stable/ 2>/dev/null || mv templates 4.5.stable
          rm -rf templates Godot_v4.5-stable_export_templates.tpz
      
      - name: Create export preset
        run: |
          mkdir -p build
          cat > export_presets.cfg << 'EOF'
          [preset.0]
          name="Web"
          platform="Web"
          runnable=true
          dedicated_server=false
          custom_features=""
          export_filter="all_resources"
          include_filter=""
          exclude_filter=""
          export_path="build/index.html"
          encryption_include_filters=""
          encryption_exclude_filters=""
          script_export_mode=1
          script_encryption_key=""
          
          [preset.0.options]
          custom_template/debug=""
          custom_template/release=""
          variant/multithread_debug=false
          html/export_icon=true
          html/preload_size=0
          progressive_web_app/enabled=false
          progressive_web_app/offline_page=""
          progressive_web_app/display="fullscreen"
          progressive_web_app/orientation="portraitOrLandscape"
          progressive_web_app/icon_144x144=""
          progressive_web_app/icon_180x180=""
          progressive_web_app/icon_512x512=""
          progressive_web_app/background_color=Color(0, 0, 0, 1)
          EOF
      
      - name: Export Godot project
        run: |
          ./godot_engine/Godot_v4.5-stable_linux.x86_64 --export-release "Web" --headless
      
      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./build
